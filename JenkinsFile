pipeline {
    agent {
        docker {
            image 'python:3.8'
            args '--user 0:0'
        }
    }

    environment {
        SF_ACCOUNT         = 'tu-cuenta.snowflakecomputing.com'
        SF_USERNAME        = 'USUARIO_EJEMPLO'
        SF_ROLE            = 'SYSADMIN'
        SF_WAREHOUSE       = 'COMPUTE_WH'
        SF_DATABASE        = 'DEMO_DB'
        SNOWFLAKE_PASSWORD = credentials('SNOWFLAKE_PASSWORD')
    }

    stages {
        stage('Run schemachange') {
            steps {
                sh '''
                    pip install schemachange --upgrade

                    cat > connections.toml << EOF
[connections.Connection_1]
account = "${SF_ACCOUNT}"
user = "${SF_USERNAME}"
password = "${SNOWFLAKE_PASSWORD}"
role = "${SF_ROLE}"
warehouse = "${SF_WAREHOUSE}"
database = "${SF_DATABASE}"
schema = "SCHEMACHANGE"
change_history_table = "${SF_DATABASE}.SCHEMACHANGE.CHANGE_HISTORY"
EOF

                    # Usa solo el nombre del archivo, sin ruta absoluta
                    schemachange -f migrations --connections-file-path connections.toml --connection-name Connection_1 --create-change-history-table
                '''
            }
        }
    }
}
