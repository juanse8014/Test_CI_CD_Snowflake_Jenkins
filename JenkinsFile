pipeline {
    agent {
        docker {
            image 'python:3.8'
            args '--user 0:0'
        }
    }

    parameters {
        password(name: 'SNOWFLAKE_PASSWORD', defaultValue: '', description: 'Snowflake password')
    }

    environment {
        SF_ACCOUNT   = 'tu-cuenta.snowflakecomputing.com'
        SF_USERNAME  = 'TU_USUARIO'
        SF_ROLE      = 'SYSADMIN'
        SF_WAREHOUSE = 'COMPUTE_WH'
        SF_DATABASE  = 'DEMO_DB'
        SNOWFLAKE_PASSWORD = "${params.SNOWFLAKE_PASSWORD}"
    }

    stages {
        stage('Run schemachange') {
            steps {
                sh '''
                    pip install schemachange --upgrade

                    cat > connections.toml << EOF
[connections.Connection_1]
account = "${SF_ACCOUNT}"
user = "${SF_USERNAME}"
password = "${SNOWFLAKE_PASSWORD}"
role = "${SF_ROLE}"
warehouse = "${SF_WAREHOUSE}"
database = "${SF_DATABASE}"
schema = "SCHEMACHANGE"
change_history_table = "${SF_DATABASE}.SCHEMACHANGE.CHANGE_HISTORY"
EOF

                    schemachange -f migrations --connection-name Connection_1 --connections-file-path connections.toml --create-change-history-table
                '''
            }
        }
    }
}
